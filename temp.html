
<html>
  <head>
    <style>
      body {
        font-family: sans-serif;
      }
      h1 {
        margin-bottom: 0;
      }
      .todoList {
        list-style-type: none;
        list-style-position: inside;
        padding-left: 0;
      }
      .checked {
        text-decoration: line-through;
        text-decoration-color: red;
        brightness: 0.5;
        color: rgba(155,155,155,0.5);
      }
      .text {
        min-width: 32ch;
        min-width: 0;
        background-color: transparent;
        border: 0;
        padding: 5px;
        margin: 0;
        outline: none;
        resize: none;
        font-family: inherit;
        font-size: 15px;
        color: white;
        overflow: hidden;
      }
      .add_button {
        width: 20px;
        height: 20px;
        background-color: #ffffff59;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        margin-left: 10px;
        margin-right: 10px;
        opacity: 0; /* make the button invisible initially */
        transition: opacity 0.3s;
      }
      .container {
        display: flex;
        flex-direction: row;
        align-items: center;
      }
      .container:hover .add_button {
        opacity: 1; /* make the button visible when the container is hovered */
      }
      h2,
      h3,
      h4 {
        margin: 0;
      }
      .h1 {
        font-size: 2em;
        font-weight: bold;
        outline: none;
        border: none;
      }

      .h2 {
        font-size: 1.5em;
        font-weight: bold;
        outline: none;
        border: none;
      }

      .h3 {
        font-size: 1em;
        font-weight: bold;
        outline: none;
        border: none;
      }
      .tooltipList {
        position: absolute;
        width: 80px;
        top: 0;
        left: 0;
        list-style: none;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        z-index: 100;
        display: none;
      }
      .tooltipList li {
        border-bottom: 1px solid #bbbbbb;
      }
      .tooltipList li button {
        outline: none;
        border: none;
        padding: 5px;
        width: 100%;
        text-align: left;
        cursor: pointer;
      }
      .tooltipList li button:last-child {
        border-bottom: none;
      }
      .tooltipList li button:hover {
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="tooltipList" id="tooltipList"></div>
    <h1>All Content</h1>
    Created on: 1/14/2024, 11:49:25 AM<br />
    Last updated on: 1/28/2024, 8:36:08 PM<br />
    <hr />
    <div class="container"> <button class="add_button" onclick="addElement()">+</button><h1><INPUT id="0" class="text h1" tabindex="0"  placeholder="Heading 1" name="editor" value='This is the firts heading 1' /></h1></div><div class="container"> <button class="add_button" onclick="addElement()">+</button><h2><INPUT id="2" class="text h2"  tabindex="2"  placeholder="Heading 2" name="editor" value='This is headeing 2' /></h2></div><div class="container"> <div class="add_button">+</div><INPUT id="3" class="text" tabindex="3"  placeholder="type '/' to enter command mode" name="editor" value='' /> <br/></div>
    <div class="container"> 
      <div class="add_button">+</div>
      <INPUT id="newItem" class="text" tabindex="-1"  placeholder="type '/' to enter command mode" name="editor" value='' /> 
      <br/>
    </div>
    <br />
  </body>

  <script>
    const vscode = acquireVsCodeApi();
    let commandMode = false;
    
    const actionElements = {
      h1: {
        type: "h1",
        content: "",
        id: 1,
      },
      h2: {
        type: "h2",
        content: "",
        id: 2,
      },
      h3: {
        type: "h3",
        content: "",
        id: 3,
      },
      todoList: {
        type: "todoList",
        content: [
          {
            type: "todoItem",
            content: "",
            done: false,
            id: 4,
          }
        ],
        id: 9,
      },
      text: {
        type: "text",
        content: "",
        id: 16,
      },
      "bullet List": {
        type: "bl",
        content: [
          {
            type: "text",
            content: "",
            id: 10,
          }
        ],
        id: 17,
      },
    };
    const textInput = document.getElementById("newItem");
    if (textInput) {
      textInput.addEventListener("keydown", function (event) {
        if (event.key === "/") {
          commandMode = true;
        }
      });
    }

    const addElement = () => {
      let element = {
        type: "text",
        content: "adding test",
        id: 100,
      };
      vscode.postMessage({
        command: "addElement",
        element: element,
      });
    };
    function populateListAction(elementName) {
      elementName = elementName.replace("/", "");

      document.getElementById("tooltipList").innerHTML = "";
      const tooltipList = document.getElementById("tooltipList");
      for (const [key, value] of Object.entries(actionElements)) {
        if (key.includes(elementName)) {
          let li = document.createElement("li");
          li.setAttribute("id", key);
          let button = document.createElement("button");
          button.innerHTML = key;
          button.addEventListener("click", function () {
            vscode.postMessage({
              command: "addElement",
              element: value,
            });
          });
          li.appendChild(button);
          tooltipList.appendChild(li);
        }
      }
    }

    //Shift focus to newly added element
    window.addEventListener("message", (event) => {
      const message = event.data;
      switch (message.command) {
        case "updateFocus":
          console.log("Updating focus: " + message.id);
          document.getElementById(message.id).focus();
          break;
      }
    }
    );
    
    document.getElementsByName("editor").forEach((e) => {
      e.addEventListener("keydown", function (event) {
        if (commandMode) {
          populateListAction(event.target.value + event.key);
        }
        if (event.key === "/") {
          // Show command menu
          let tootTip = document.getElementById("tooltipList");
          tootTip.style.display = "block";
          const caretPosition = getCaretCoordinates();

          tootTip.style.top = caretPosition.y + 30 + "px";
          tootTip.style.left = caretPosition.x + "px";
          commandMode = true;

          populateListAction(event.target.value);
        }
        if (event.key === "Escape") {
          // Hide command menu
          document.getElementById("tooltipList").style.display = "none";
          document.getElementById("tooltipList").innerHTML = "";
          commandMode = false;
        }
        if (event.key === " ") {
          // Hide command menu
          document.getElementById("tooltipList").style.display = "none";
          document.getElementById("tooltipList").innerHTML = "";
          commandMode = false;
        }
        if (event.key === "Backspace") {
          // Hide command menu
          document.getElementById("tooltipList").style.display = "none";
          document.getElementById("tooltipList").innerHTML = "";
          commandMode = false;
          if (event.target.value === "") {
            vscode.postMessage({
              command: "deleteElement",
              id: event.target.id,
            });
          }
        }
        if (event.key === "Enter") {
          //Check if in command Mode
          if (commandMode) {
            populateListAction(event.target.value);
            //get the first element in command menu
            const firstElement = document.getElementById("tooltipList")

            //add new element
            let actionKey = firstElement.firstElementChild.id;
            let element = actionElements[actionKey];
            vscode.postMessage({
              command: "addElement",
              element: element,
            });


            // Hide command menu
            document.getElementById("tooltipList").style.display = "none";
            document.getElementById("tooltipList").innerHTML = "";
            commandMode = false;
          }
          else {
            console.log(event.target.classList);
            if(event.target.classList.contains("todoText")){
              // Add new todo item
              console.log("Adding new todo item");
              let element = {
                type: "todoItem",
                content: "",
                done: false,
                id: 100,
                sibling_id: event.target.id
              };
              vscode.postMessage({
                command: "addElement",
                element: element,
              });
            }
            else if(event.target.classList.contains("listText")){
              console.log("Adding new list item");
              // Add new  list item
              let element = {
                type: "listText",
                content: "",
                id: 100,
                sibling_id: event.target.id
              };
              vscode.postMessage({
                command: "addElement",
                element: element,
              });
            }
            else{
              // Add new  text item
              let element = {
                type: "text",
                content: "",
                id: 100,
              };
              vscode.postMessage({
                command: "addElement",
                element: element,
              });
            }
          }
        }
      });


       e.onchange = (event) =>{
        console.log("onchange"); 
        let id = event.target.id;
        let content = event.target.value;
        console.log("id: "+ id);
        console.log("content: "+ content);

        // Update the content
        vscode.postMessage({
          command: "updateContent",
          id: id,
          content: content,
        });
      }
    });


    document.getElementsByName("todo_box").forEach((e) => {
      e.onchange = (event) => {
        let id = event.target.id.replace("_box", "");
        vscode.postMessage({
          command: "toggleTodoItem",
          id: id,
        });
      }

    });

    function getCaretCoordinates() {
      let x = 0,
        y = 0;
      let focused = document.activeElement;
      if (!focused) {
        return { x, y };
      }
      const rect = focused.getBoundingClientRect();
      x = rect.left + focused.selectionStart;
      y = rect.top + focused.selectionEnd;

      return { x, y };
    }

  </script>
</html>

       